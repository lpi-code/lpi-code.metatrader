- name: Create autostart directory
  ansible.builtin.file:
    path: "{{ metatrader_home }}/.config/autostart"
    state: directory
    owner: "{{ metatrader_user }}"
    group: "{{ metatrader_group }}"
    mode: '0755'

- name: Create metatrader autostart file
  ansible.builtin.template:
    dest: "{{ metatrader_home }}/.config/autostart/metatrader_{{ metatrader_instance_number }}.desktop"
    owner: "{{ metatrader_user }}"
    group: "{{ metatrader_group }}"
    mode: '0644'
    content: |
      [Desktop Entry]
      Type=Application
      Name=MetaTrader {{ metatrader_instance_number }}
      Exec=bash -c "while true; do env WINEPREFIX={{ metatrader_home }}/.mt5_{{ metatrader_instance_number }} WINEARCH=win32 /usr/bin/wine {{ metatrader_home }}/.mt5_{{ metatrader_instance_number }}/drive_c/Program\ Files/MetaTrader\ 5/mt5.exe; sleep 3; done"
      Hidden=false
      NoDisplay=false
      X-GNOME-Autostart-enabled=true
      OnlyShowIn=XFCE;Openbox;

- name: Ensure xfce4 session autostart is enabled
  ansible.builtin.lineinfile:
    path: "{{ metatrader_home }}/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-session.xml"
    line: '<?xml version="1.0" encoding="UTF-8"?><channel name="xfce4-session" version="1.0"><property name="general" type="empty"><property name="AutostartEnabled" type="bool" value="true"/></property></channel>'
    create: yes
    owner: "{{ metatrader_user }}"
    group: "{{ metatrader_group }}"
    mode: '0644'
